<div class="admin-layout" [class.sidebar-collapsed]="!sidebarOpen()">

  <!-- SIDEBAR -->
  <aside class="sidebar" [class.open]="sidebarOpen()" role="navigation" aria-label="Sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">
          <img src="assets/logoFitBerry.jpeg" alt="FitBerry Logo">
        </span>
        <span class="logo-text" *ngIf="sidebarOpen()">FitBerry</span>
      </div>
      <button class="toggle-btn" (click)="toggleSidebar()" aria-label="Toggle sidebar">
        <svg *ngIf="sidebarOpen()" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.41 7.41L14 6L8 12L14 18L15.41 16.59L10.83 12L15.41 7.41Z" fill="currentColor"/>
        </svg>
        <svg *ngIf="!sidebarOpen()" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8.59 16.59L10 18L16 12L10 6L8.59 7.41L13.17 12L8.59 16.59Z" fill="currentColor"/>
        </svg>
      </button>
    </div>

    <div class="admin-badge" *ngIf="sidebarOpen()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1Z" fill="currentColor"/>
      </svg>
      <span>Admin Panel</span>
    </div>

    <nav class="nav-menu" aria-label="Admin navigation">
      <button class="nav-item" [class.active]="activeTab() === 'stats'" (click)="setTab('stats')" type="button">
        <span class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM9 17H7V10H9V17ZM13 17H11V7H13V17ZM17 17H15V13H17V17Z" fill="currentColor"/>
          </svg>
        </span>
        <span class="nav-text" *ngIf="sidebarOpen()">Dashboard</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'users'" (click)="setTab('users')" type="button">
        <span class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 11C17.66 11 18.99 9.66 18.99 8C18.99 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 10.99 9.66 10.99 8C10.99 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.67 13 1 14.17 1 16.5V19H15V16.5C15 14.17 10.33 13 8 13ZM16 13C15.71 13 15.38 13.02 15.03 13.05C16.19 13.89 17 15.02 17 16.5V19H23V16.5C23 14.17 18.33 13 16 13Z" fill="currentColor"/>
          </svg>
        </span>
        <span class="nav-text" *ngIf="sidebarOpen()">Users</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'articles'" (click)="setTab('articles')" type="button">
        <span class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM16 18H8V16H16V18ZM16 14H8V12H16V14ZM13 9V3.5L18.5 9H13Z" fill="currentColor"/>
          </svg>
        </span>
        <span class="nav-text" *ngIf="sidebarOpen()">Articles</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'commentaires'" (click)="setTab('commentaires')" type="button">
        <span class="nav-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM18 14H6V12H18V14ZM18 11H6V9H18V11ZM18 8H6V6H18V8Z" fill="currentColor"/>
          </svg>
        </span>
        <span class="nav-text" *ngIf="sidebarOpen()">Comments</span>
      </button>
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" (click)="logout()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.59L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z" fill="currentColor"/>
        </svg>
        <span *ngIf="sidebarOpen()">Logout</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content" role="main" aria-live="polite">

    <!-- Top Bar -->
    <header class="top-bar">
      <div class="page-info">
        <h1>
          <ng-container [ngSwitch]="activeTab()">
            <span *ngSwitchCase="'stats'">Dashboard</span>
            <span *ngSwitchCase="'users'">User Management</span>
            <span *ngSwitchCase="'articles'">Article Management</span>
            <span *ngSwitchCase="'commentaires'">Comment Management</span>
            <span *ngSwitchCase="'create-user'">Create New User</span>
            <span *ngSwitchCase="'edit-user'">Edit User</span>
            <span *ngSwitchCase="'edit-article'">{{ getEditingArticle()?.id ? 'Edit Article' : 'Create Article' }}</span>
          </ng-container>
        </h1>
        <p class="page-subtitle">FitBerry Administration</p>
      </div>

      <div class="top-actions">
        <div class="search-box" *ngIf="activeTab() === 'users' || activeTab() === 'articles'">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="currentColor"/>
          </svg>
          <input
            type="text"
            placeholder="Search..."
            [value]="searchTerm()"
            (input)="searchTerm.set($any($event.target).value)"
            aria-label="Search">
        </div>

        <button class="btn-add" *ngIf="activeTab() === 'users'" (click)="createUser()" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
          </svg>
          <span>Add User</span>
        </button>
      </div>

      <div class="notification">
        <app-notification-modal></app-notification-modal>
      </div>
    </header>

    <!-- Notification -->
    <div *ngIf="showNotification()" class="notification" [class]="showNotification()?.type">
      {{ showNotification()?.message }}
    </div>

    <!-- STATS TAB -->
    <section class="tab-content" *ngIf="activeTab() === 'stats'">
      <div class="stats-grid">
        <div class="stat-card" *ngFor="let card of statsCards()" [style.--accent]="card.color">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path [attr.d]="getIconSvg(card.icon)" fill="currentColor"/>
            </svg>
          </div>
          <div class="stat-info">
            <h3>{{ card.value }}</h3>
            <p>{{ card.title }}</p>
            <small>{{ card.subtitle }}</small>
          </div>
        </div>
      </div>

      <div class="charts-row">
        <div class="chart-card circular-chart-card">
          <h3>Data Distribution</h3>
          <div class="circular-chart-container">
            <svg viewBox="0 0 200 200" class="pie-chart" xmlns="http://www.w3.org/2000/svg">
              <ng-container *ngFor="let item of chartData(); let i = index">
                <circle
                  [attr.cx]="100"
                  [attr.cy]="100"
                  [attr.r]="60"
                  fill="transparent"
                  [attr.stroke]="item.color"
                  [attr.stroke-width]="40"
                  [attr.stroke-dasharray]="item.percentage + ' ' + (100 - +item.percentage)"
                  [attr.transform]="'rotate(' + getRotation(i) + ' 100 100)'"
                  class="pie-segment">
                </circle>
              </ng-container>
              <circle cx="100" cy="100" r="35" fill="white"></circle>
            </svg>
            <div class="chart-legend">
              <div class="legend-item" *ngFor="let item of chartData()">
                <span class="legend-color" [style.background]="item.color"></span>
                <span class="legend-label">{{ item.label }}</span>
                <span class="legend-value">{{ item.value }} ({{ item.percentage }}%)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- USERS TAB -->
    <section class="tab-content" *ngIf="activeTab() === 'users'">
      <div class="table-wrapper">
        <table class="data-table" role="table" aria-label="Users table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers()">
              <td class="td-id">#{{ user.id }}</td>
              <td>{{ getUserDisplayName(user) }}</td>
              <td>{{ user.email }}</td>
              <td>
                <span class="role-badge" [class]="user.role?.toLowerCase()">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td class="actions">
                <button class="btn-icon edit" (click)="navigateToEdit('user', user.id!)" aria-label="Edit user">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>
                  </svg>
                </button>
                <button class="btn-icon delete" (click)="deleteItem('user', user)" aria-label="Delete user">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
                  </svg>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="filteredUsers().length === 0" class="empty-table">No users found</div>
      </div>
    </section>

    <!-- ARTICLES TAB -->
    <section class="tab-content" *ngIf="activeTab() === 'articles'">
      <div class="articles-grid">
        <div class="article-card" *ngFor="let a of filteredArticles()">
          <div class="article-body">
            <h4>{{ a.titre }}</h4>
            <p class="description">{{ a.description | slice:0:120 }}{{ a.description.length > 120 ? '...' : '' }}</p>
            <p class="article-meta">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
              </svg>
              {{ a.auteurPrenom }} {{ a.auteurNom }}
            </p>
          </div>
          <div class="article-actions">
            <button class="btn-sm edit" (click)="navigateToEdit('article', a.id!)" type="button">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>
              </svg>
              Edit
            </button>
            <button class="btn-sm delete" (click)="deleteItem('article', a)" type="button">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
              </svg>
              Delete
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="filteredArticles().length === 0" class="empty-cards">No articles found</div>
    </section>

    <!-- COMMENTS TAB -->
    <section class="tab-content" *ngIf="activeTab() === 'commentaires'">
      <div class="table-wrapper">
        <table class="data-table" role="table" aria-label="Comments table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Article</th>
              <th>Comment</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let comment of getCommentaires()">
              <td class="td-id">#{{ comment.id }}</td>
              <td>{{ comment.titre || '-' }}</td>
              <td>{{ getArticleTitle(comment.articleId || 0) }}</td>
              <td class="comment-text">{{ comment.description | slice:0:50 }}{{ comment.description.length > 50 ? '...' : '' }}</td>
              <td>{{ formatDate(comment.createdAt) }}</td>
              <td class="actions">
                <button class="btn-icon delete" (click)="deleteCommentaire(comment.id!)" aria-label="Delete comment">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
                  </svg>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="getCommentaires().length === 0" class="empty-table">No comments found</div>
      </div>
    </section>

    <!-- FORM TABS -->
    <section class="tab-content" *ngIf="activeTab() === 'create-user'">
      <app-user-form
        [user]="getEditingUser()"
        [isEditMode]="false"
        (submit)="onFormSubmit('user')"
        (cancel)="onFormCancel('user')">
      </app-user-form>
    </section>

    <section class="tab-content" *ngIf="activeTab() === 'edit-user'">
      <app-user-form
        [user]="getEditingUser()"
        [isEditMode]="true"
        (submit)="onFormSubmit('user')"
        (cancel)="onFormCancel('user')">
      </app-user-form>
    </section>

    <section class="tab-content" *ngIf="activeTab() === 'edit-article'">
      <app-article-form
        [article]="getEditingArticle()"
        [isEditMode]="getEditingArticle()?.id !== undefined"
        (submit)="onFormSubmit('article')"
        (cancel)="onFormCancel('article')">
      </app-article-form>
    </section>

  </main>
</div>
